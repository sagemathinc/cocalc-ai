# Project-Host Bootstrap Rewrite Plan (Python-First)

Goal: replace the brittle shell-heavy bootstrap in [src/packages/server/cloud/bootstrap-host.ts](./src/packages/server/cloud/bootstrap-host.ts) with a **Python-driven bootstrapper** (invoked by a tiny shell stub). Keep the Golang connector as the entrypoint. Emphasize clarity, observability, parallelism, robustness, and maintainability.

---

## 0) Guiding principles

- **Single source of truth** for paths, user, and state.
- **Deterministic**: same inputs → same outputs; no reliance on ambient shell variables.
- **Observable**: every step writes structured progress to a log and to the hub status endpoint.
- **Recoverable**: safe to re-run; idempotent where possible.
- **Fast**: parallelize independent tasks (apt + bundle downloads + node setup).
- **Strict**: explicit environment + type checking + internal consistency checks.

---

## 1) Target architecture

### 1.1 Tiny shell stub (minimal and deterministic)

- Responsibilities:
  - Determine **BOOTSTRAP_USER** (passed by connector or derived).  Must NOT be root.
  - Create `$HOME/cocalc-host/bootstrap/bootstrap.log`.
  - Download [**bootstrap.py**](http://bootstrap.py) into `$HOME/cocalc-host/bootstrap/bootstrap.py` 
    - Do not ship it in the connector bundle since the connector is in Golang and should very rarely change, whereas [bootstrap.py](http://bootstrap.py) is much more likely to get updated regularly.
  - Execute: `python3 bootstrap.py --config <path>`
  - Exit non‑zero if any step fails.
- No apt installs. No complex logic. No downloads beyond [bootstrap.py](http://bootstrap.py) itself (or fetch from bundle).

### 1.2 Python bootstrapper (the real logic)

- File: `bootstrap.py` (generated by server).
- Inputs: one **config JSON** file (paths + URLs + versions).
- Outputs:
  - `/etc/cocalc/project-host.env`
  - `$HOME/cocalc-host/{bin,bootstrap,bundles,config,logs}`
  - `/btrfs` mounted and ready
  - `node` installed via nvm under `$HOME/.nvm`
  - project-host + project bundle + tools installed and verified
  - system services started (project-host daemon + connector state)

Progress: This should clearly indicate progress in various ways, starting with logging to bootstrap.log.  We will also want progress updates that are sent to the hub so user gets realtime updates.

Parallelism: Do as much as possible in parallel, but make this easy to turn off for debugging purposes.  Add a `parallel` boolean to the config (default true).

### 1.3 Config file layout

- One JSON file, e.g. `$HOME/cocalc-host/bootstrap/bootstrap-config.json`.
- Minimal required fields (explicit and typed):
  - `bootstrap_user`
  - `bootstrap_root` (e.g. `/home/<user>/cocalc-host`)
  - `bootstrap_dir` (`{bootstrap_root}/bootstrap`)
  - `bundle_urls` (project-host, project-bundle, tools per-arch)
  - `bundle_checksums`
  - `node_version`
  - `apt_packages`
  - `btrfs_image_target_gb` (computed from disk size or passed in)
  - `host_id`, `host_name`, `conat_urls`, `ssh tunnel params` (if needed)
  - `arch`, `os_release`

---

## 2) Bootstrap flow (step-by-step)

1. **Preflight checks**
   - Must be Ubuntu (24.x+), systemd present.
   - Must be non-root runtime user (BOOTSTRAP_USER).
   - Must have sudo without password (`sudo -n true`).
   - Ensure `$HOME` is resolved via `getent passwd $BOOTSTRAP_USER` (avoid `/root`).
   - Ensure `$HOME/cocalc-host` is writable.

2. **Create canonical directory structure**
   - `$BOOTSTRAP_ROOT/{bin,bootstrap,bundles,config,logs}`
   - All owned by BOOTSTRAP_USER.
   - Write README and env helper.

3. **Write environment / config files**
   - `/etc/cocalc/project-host.env` (atomic write).
   - `$BOOTSTRAP_ROOT/config/bootstrap.json`.

4. **Parallel step group A (run concurrently)**
   - **A1**: `apt-get update` and `apt-get install` (robust with retries/timeouts).
   - **A2**: download project-host bundle.
   - **A3**: download project bundle.
   - **A4**: download tools bundle (arch-specific).
   - **A5**: install Node via nvm.

5. **Verify downloads**
   - Check SHA256 if provided; else attempt `.sha256` fetch.
   - Verify bundle structure, manifest, expected files.

6. **Install artifacts**
   - Extract bundles into `$BOOTSTRAP_ROOT/bundles/<version>`.
   - Symlink `$BOOTSTRAP_ROOT/bundle` to chosen version.
   - Set executable permissions as required.

7. **Btrfs setup**
   - Create image file.
   - Format & mount under `/btrfs`.
   - Setup directories, quota, sync-state, etc.

8. **Start services**
   - Start project-host daemon.
   - Ensure connector-managed tunnels are active if needed.
   - Verify health endpoints (conat, status).

9. **Finalize**
   - Write `.bootstrap_done`.
   - Report success to hub.

---

## 3) Robustness & retries

### 3.1 Apt robustness

- Use `timeout` for `apt-get update` and `apt-get install`.
- Retry 3 times with exponential backoff.
- Use flags:
  - `-y`
  - `-o Dpkg::Options::=--force-confold`
  - `-o Dpkg::Options::=--force-unsafe-io`
  - `-o Acquire::Retries=3`
  - `-o Acquire::http::Timeout=20`
  - `-o Acquire::https::Timeout=20`
  - `-o Acquire::ftp::Timeout=20`
  - `-o Acquire::CompressionTypes::Order::=gz`

### 3.2 Downloads

- Use `curl --fail --location --retry 3 --retry-all-errors --connect-timeout 10`.
- Verify checksums; fail fast if mismatch.

### 3.3 Idempotency

- Each step checks if already satisfied (e.g., bundles present, node version installed, /btrfs mounted).

---

## 4) Observability

- Structured logging with:
  - timestamp
  - step name
  - duration
  - exit code
  - stdout/stderr snippet
- All logs in `$BOOTSTRAP_ROOT/logs/bootstrap.log`.
- Push progress to hub via status endpoint (phase + percent).
- Emit timings per step for quick bottleneck diagnostics.
- On failure: emit actionable remediation hints.

---

## 5) Type checking & tests

### 5.1 Type checking

- Type checking happens in CI/dev:
  - Use `pydantic` in development (pinned) for schema validation.
  - Use `mypy`/`ruff` for static checking.
- Runtime bootstrap should have **zero Python deps**:
  - Implement a small manual schema check (dataclasses + explicit validation).

### 5.2 Integration tests

- Minimal: run bootstrap in a clean VM (arm64 + x64).
- Check expected artifacts: bundles installed, services running, /btrfs mounted.

### 5.3 Linting

- Add `pnpm lint:shell` for any shell stubs or scripts.
- Add `pnpm lint:bootstrap` to run python lint/type-check (ruff/mypy).

---

## 6) Migration & rollout

- Keep old shell path for one version behind a feature flag.
  - NO: it doesn't even work right now (e.g., weird permission issues due to recent refactoring work), and this is completely GREENFIELD with no deploys or production or even public alpha tests!
- Thus always use Python bootstrap.

---

## 7) Concrete implementation plan

1. **Add**  bootstrap.py **template** in server-side generation.
2. **Refactor bootstrap-host.ts** to emit:
   - shell stub
   - config JSON
   - bootstrap.py 
     - But bootstrap.py should not be a templated strig in bootstrap-host.ts -- that's just confusing. Write it as a proper python file with arguments or env variables as needed for configuration, not templated scripts.
3. **Add robust download/apt helpers** in Python.
4. **Add logging + status reporting**.
5. **Wire hub UI** to show progress.
6. **Add lint/test tasks** for python + shell.
7. **Remove legacy shell logic** once validated.

---

## 8) Open questions

- Where should bootstrap.py live for updates (bundled vs. fetched)?
- How to version pin Python dependencies, if any?
- Minimal set of apt packages for baseline host?
- How to avoid holding apt lock too long in parallel mode?
